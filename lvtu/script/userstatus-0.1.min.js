;
(function() {
	var a = {
		version : "0.1",
		_COOKIEHASH : null,
		_mouseOn : false,
		_conf : typeof (QNR) != "undefined" && QNR.UserStatusConfig ? QNR.UserStatusConfig
				: {},
		$ : function(b) {
			return document.getElementById(b)
		},
		_cookie : function(d) {
			if (!this._COOKIEHASH) {
				this._COOKIEHASH = {};
				var f = document.cookie.split(";");
				for ( var b = 0; b < f.length; b++) {
					var g = f[b];
					var e = g.split("=");
					if (g.indexOf("=") != -1) {
						this._COOKIEHASH[this._trim(e[0])] = this._trim(e[1])
					}
				}
			}
			return this._COOKIEHASH[d]
		},
		_trim : function(b) {
			if (String.prototype.trim) {
				return b.trim()
			}
			return b.replace(/^\s+/, "").replace(/\s+$/, "")
		},
		islogin : function() {
			if (this._cookie('customer_id')) {
				return true;
			}
			return false;
			if (this._cookie("_t") && this._cookie("_q")
					&& this._cookie("_q").indexOf("G.") < 0||this._cookie("QN15") && this._cookie("QN19")) {
				return true
			} else {
				return false
			}
		},
		_getinfo : function() {
			var f = {
				from : window.__qunarglobal_from || ""
			};
			var d = "";
			var h = "";
			var c = this._cookie("QN16");
			var g = this._cookie("QN21");
			var e = this._cookie("QN15");
			var m = this._cookie("QN42");// 增加用户昵称
			var m = this._cookie('customer_name');//'lwkTest';
			if (typeof (c) !== "undefined") {
				switch (c) {
				case "1":  // 第三方绑定
					d = m;// this._getQunarUserName();
					h = m;// this._getQunarUserName();
					break;
				case "0":  // 第三方未绑定
					d = g;
					h = e;
					break;
				default:
					d = m;// this._getQunarUserName();
					h = m;// this._getQunarUserName()
				}
			} else {
				d = m;// this._getQunarUserName();
				h = m // this._getQunarUserName()
			}
			f.displayName = decodeURIComponent(d).replace(/\"/g, "");
			f.username = decodeURIComponent(h).replace(/\"/g, "");
			this._console(d);
			return f
		},
		_getQunarUserName : function() {
			var d = "";
			var c = this._cookie("_q");
			var b = this._cookie("_a");
			if (c) {
				if (b) {
					d = this._trim(c.replace("U.", "") + "(未激活)")
				} else {
					d = this._trim(c.replace("U.", ""))
				}
			}
			return d
		},
		_console : function() {
			if (typeof (console) != "undefined" && console.info) {
				var c = [];
				for ( var b = 0; b < arguments.length; b++) {
					c.push(arguments[b])
				}
				console.info(c.join(" "))
			}
		},
		render : function() {
			this._creatStyle();
			if (!this._conf || !this._conf.id) {
				this._console("no userstatus id, render by document.write");
				document.write(this._creatHTML());
				this._complate();
				return
			}
			var b = this.$(this._conf.id);
			if (!b) {
				this._console("can't find the element \"", this._conf.id, '"');
				return
			}
			b.innerHTML = this._creatHTML();
			this._complate();
			return
		},
		_complate : function() {
			var b = this;
			this._regEvent();
			if (this._conf.complate) {
				setTimeout(function() {
					b._conf.complate()
				}, 0)
			}
		},
		_creatStyle : function() {
			var b = document.createElement("style");
			b.type = "text/css";
			var c = "			.myMenuHide__ { display:none; }			.qn_header .myMenuList__ { background:#fff; border:1px solid #666; position:absolute; right:126px; text-align:left; top:-3px; width:69px; } 			.qn_header .qaccess a.myMenuLink__ { padding-right:9px; position:relative; }			.qn_header .qaccess a.myMenuLink__:hover { color:#000 !important; } 			.qn_header .myMenuList__ .top { border-bottom:1px solid #666; height:21px; } 			.qn_header .myMenuList__ li a { color:#555; display:block; height:21px; line-height:21px; padding-left:5px; } 			.qn_header .myMenuList__ li a:hover { background:#4878da; color:#fff !important; }			";
			if (b.styleSheet) {
				b.styleSheet.cssText = c
			} else {
				b.appendChild(document.createTextNode(c))
			}
			document.getElementsByTagName("head")[0].appendChild(b)
		},
		_creatHTML : function() {
			var b = [];
			var e = this._getinfo();
			var d = encodeURIComponent(window.location.href);
			
			// 补充#号内容
			var url=window.location.href;
			var strs= new Array(); // 定义一数组
			strs=url.split("#"); // 字符分割
			if(strs!=undefined&&strs!=""&&strs!=null){
				if(strs[1]!=undefined&&strs[1]!=""&&strs[1]!=null){
					d = d + "#" +strs[1];
				}
			}
			
			if (this.islogin()) {
				var g = this._creaHtmlEx();
				b.push(g);
				b.push('<a href="' + base_url + '/account_edit.php" style="color:#666666">',e.displayName, "</a> | ");
				var f = this._conf.title;
				var c = this._conf.list;
				if (f) {
					b.push('<a href="#" onclick="return false;" hidefocus="on" class="myMenuLink__" id="__myMenuTitle__">',f);
					if (c) {
						b.push('<img src="../image/icons/icon.my.gif" class="da" />')
					}
					b.push("</a> | ")
				}
				b.push('<a href="' + base_url + '/logoff.php?ret=', d,'">退出</a>')
			} else {
				b.push('<a href="' + base_url + '/login.php?ret=',d,'">登录</a> | <a href="' + base_url + '/create_account.php?ret=',d, '">注册</a>')
			}
			return b.join("")
		},
		_creaHtmlEx : function() {
			var e = this._conf.list;
			var f = this._getinfo();
			if (typeof (this._conf.creatEx) === "function") {
				return this._conf.creatEx.call(this)
			}
			if (e && e.length > 0) {
				var b = [];
				b
						.push('<div id="__myMenuInfo__" class="myMenuList__ myMenuHide__">');
				b.push('	<div class="top"></div>');
				b.push('	<div class="menu">');
				b.push("		<ul>");
				for ( var c = 0; c < e.length; c++) {
					var d = e[c].link;
					var g = e[c].text;
					b.push('<li><a href="', d.replace(/#{username}/g,
							f.username), '">', g, "</a></li>")
				}
				b.push("		</ul>");
				b.push("	</div>");
				b.push("</div>");
				return b.join("")
			} else {
				return ""
			}
		},
		showEx : function() {
			var b = this.$("__myMenuInfo__");
			if (b && !this._mouseOn) {
				this.removeCss(b, "myMenuHide__")
			}
			this._mouseOn = true
		},
		hideEx : function() {
			var b = this.$("__myMenuInfo__");
			if (b) {
				this.addCss(b, "myMenuHide__")
			}
			this._mouseOn = false
		},
		addCss : function(b, c) {
			if (!b) {
				return
			}
			if (b.className != "") {
				if (b.className.indexOf(c) > -1) {
					b.className = b.className
				} else {
					b.className = [ b.className, " ", c ].join("")
				}
			} else {
				b.className = c
			}
		},
		removeCss : function(c, f) {
			if (!c) {
				return
			}
			var d = "";
			var b = c.className.split(" ");
			for ( var e = 0; e < b.length; e++) {
				if (b[e] != f) {
					if (e > 0) {
						d += " "
					}
					d += b[e]
				}
			}
			c.className = d
		},
		stopEvent : function(b) {
			if (!b) {
				b = window.event
			}
			if (b.stopPropagation) {
				b.stopPropagation()
			} else {
				b.cancelBubble = true
			}
		},
		mouseout_x : function(f) {
			var g = f || window.event;
			var d = g.toElement || g.relatedTarget;
			var b = this.$("__myMenuInfo__");
			if (!d) {
				this.hideEx();
				return
			}
			if (b.contains) {
				if (!b.contains(d) && d.className.indexOf("my") < 0) {
					this.hideEx()
				}
			} else {
				if (b.compareDocumentPosition) {
					var c = b.compareDocumentPosition(d);
					if (!(c == 20 || c == 0) && d.className.indexOf("my") < 0) {
						this.hideEx()
					}
				} else {
					this
							._console("element has no contains and compareDocumentPosition");
					this.hideEx()
				}
			}
		},
		_regEvent : function() {
			var b = this;
			this._bind(this.$("__myMenuTitle__"), "mouseover", function(c) {
				b.showEx()
			});
			this._bind(this.$("__myMenuInfo__"), "mouseout", function(c) {
				b.mouseout_x(c)
			})
		},
		_bind : function(c, b, d) {
			if (c) {
				if (c && c.attachEvent) {
					c.attachEvent("on" + b, function(e) {
						d(e)
					})
				} else {
					c.addEventListener(b, function(e) {
						d(e)
					}, false)
				}
			}
		}
	};
	a.render()
})();